<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intra Music</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="./output.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@700;900&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: #585be3cc; color: #ffffff; }
        .font-heading { font-family: 'Outfit', sans-serif; }
        .text-collage { font-weight: 900; line-height: 1; text-transform: uppercase; color: rgba(255, 255, 255, 0.9); }
        .hidden { display: none; }

        .glass-sphere {
            border-radius: 9999px;
            background: 
                radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 50%),
                linear-gradient(10deg, rgba(111, 115, 231, 0.91), rgba(42, 35, 203, 0.91));
            box-shadow: 
                inset -8px -8px 20px rgba(0,0,0,0.25),
                0px 10px 25px rgba(0,0,0,0.3);
        }

        .glass-button {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }

        .glass-button:hover {
            background: rgba(255,255,255,0.25);
            transform: scale(1.05);
        }

        .font-heavy { 
            font-family: 'Inter', sans-serif; 
            font-weight: 900; 
        }

        .genre-image-placeholder {
            background: linear-gradient(135deg, rgba(132, 117, 240, 0.6), rgba(88, 80, 230, 0.6));
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2); 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); 
            border-radius: 12px;
        }
    </style>
</head>

<body class="overflow-x-hidden">
    <div id="contenedor-login" class="min-h-screen flex flex-col items-center justify-center text-center p-4 hidden">
        <h1 class="font-heading text-6xl md:text-8xl font-black tracking-tighter">INTRA MUSIC</h1>
        <p class="text-xl mt-4 mb-8 text-gray-300">Mira tus estadísticas personales de Spotify.</p>
        <a href="http://127.0.0.1:5000" class="bg-green-500 text-white font-bold py-4 px-10 rounded-full shadow-lg hover:bg-green-600 transition-all transform hover:scale-105 text-lg">
            Iniciar sesión con Spotify
        </a>
    </div>

    <div id="contenido-principal" class="max-w-7xl mx-auto hidden">
        <header class="absolute top-0 left-0 right-0 z-30 p-4">
            <div class="mx-auto max-w-5xl">
                <nav class="flex justify-between items-center text-sm font-semibold tracking-wider">
                    <a href="#contenido-principal" class="flex items-center hover:opacity-80 transition-opacity mr-auto"> 
                        <svg width="45" height="45">
                            <use xlink:href="assets/svg/sprites.svg#logotemp"></use>
                        </svg>
                    </a>
                    <div class="flex items-center space-x-6">
                        <a href="#seccion-canciones" class="scroll-link hover:text-indigo-700 transition-colors">CANCIONES</a>
                        <a href="#seccion-artistas" class="scroll-link hover:text-indigo-700 transition-colors">ARTISTAS</a>
                        <a href="#resumen-personal" class="nav-link hover:text-white transition-colors bg-white/10 backdrop-blur-sm border border-transparent hover:border-white/20 px-4 py-2 rounded-full" data-route="resumen">RESUMEN PERSONAL</a>
                        <button id="open-menu-btn" class="p-2 border border-white rounded-md focus:outline-none focus:ring-2 focus:ring-white/50">
                            <svg width="24" height="24">
                                <use xlink:href="assets/svg/sprites.svg#offcanva"></use>
                            </svg>
                        </button>
                    </div>
                </nav>
            </div>
        </header>

        <main id="ruta-contenedor">
            <div id="vista-inicio" data-content-route="inicio">
                <section class="relative h-[60vh] bg-indigo-400 md:h-[80vh] flex items-center justify-center overflow-hidden">
                    <div class="absolute inset-0">
                        <div class="absolute top-[-20%] left-[-15%] w-96 h-96 glass-sphere opacity-70 blur-md"></div>
                        <div class="absolute bottom-[-10%] right-[-10%] w-[28rem] h-[28rem] glass-sphere opacity-50 blur-lg"></div>
                        <div class="absolute top-[15%] right-[20%] w-32 h-32 glass-sphere opacity-60 animate-pulse blur-sm"></div>
                    </div>
                    <div class="text-center z-0 relative">
                        <h1 class="font-heading text-7xl md:text-9xl font-black tracking-tighter">INTRA</h1>
                        <h1 class="font-heading text-7xl md:text-9x1 font-black tracking-tighter">MUSIC</h1>
                        <a href="#escuchado-recientemente" class="nav-link mt-8 glass-button text-white font-bold py-3 px-8 rounded-full uppercase tracking-widest inline-block" data-route="reciente">Escuchado Recientemente</a>
                    </div>
                </section>

                <section  id="seccion-artistas" class="py-16 md:py-24 relative" style="background-image: url('assets/static/fondo-seccion-artistas.jpg'); background-size: cover; background-position: center;">
                    <div class="absolute inset-0 bg-cyan-200/20"></div>
                    <div class="relative z-10 px-6 mx-auto max-w-5xl">
                        <h2 class="text-center font-heading text-4xl md:text-5xl font-bold mb-12 text-blue-900">Top 3 Artistas</h2>
                        <div class="contenedor-top-artistas grid grid-cols-1 md:grid-cols-3 gap-8 text-center min-h-[20rem] items-center justify-center">
                            <p class="col-span-3 text-gray-400">Cargando tu top de artistas...</p>
                        </div>
                    </div>
                </section>

                <section id="seccion-canciones" class="py-16 md:py-24 relative bg-indigo-900">
                    <div class="px-6 mx-auto max-w-4xl">
                        <h2 class="text-center font-heading text-4xl md:text-5xl font-bold mb-12">Top 10 Canciones más escuchadas</h2>
                        <div id="contenedor-top-canciones" class="grid grid-cols-1 sm:grid-cols-2 gap-x-12 gap-y-6 min-h-[10rem]">
                            <p class="col-span-2 text-gray-400 text-center">Cargando tu top de canciones...</p>
                        </div>
                    </div>
                </section>

                <section id="seccion-imagenes">
                    <div class="relative grid h-[500px] max-w-7xl grid-cols-12 grid-rows-8 mx-auto bg-sky-200 overflow-hidden">
                        <span class="z-30 col-start-1 col-span-5 row-start-1 row-span-2 font-heavy text-7xl md:text-9xl text-indigo-600 leading-none flex items-center">Dance</span>
                        <span class="z-30 col-start-8 col-span-5 row-start-1 row-span-2 font-heavy text-7xl md:text-9xl text-indigo-600 leading-none flex items-center">Hip hop</span>
                        <span class="z-30 col-start-7 col-span-8 row-start-3 row-span-2 font-heavy text-7xl md:text-9xl text-indigo-600 leading-none flex items-center">Instrumental</span>
                        <span class="z-30 col-start-1 col-span-5 row-start-5 row-span-2 font-heavy text-7xl md:text-9xl text-indigo-600 leading-none flex items-center">Metal</span>
                        <span class="z-30 col-start-7 col-span-5 row-start-5 row-span-2 font-heavy text-7xl md:text-9xl text-indigo-600 leading-none flex items-center">Salsa</span>
                        <span class="z-30 col-start-1 col-span-5 row-start-7 row-span-2 font-heavy text-7xl md:text-9xl text-indigo-600 leading-none flex items-center">Cumbia</span>
                        <span class="z-30 col-start-9 col-span-5 row-start-7 row-span-2 font-heavy text-7xl md:text-9xl text-indigo-600 leading-none flex items-center">K-Pop</span>
                        <div class="z-20 col-start-5 col-span-2 row-start-1 row-span-2 flex justify-center items-center">
                            <div class="w-5/6 h-5/6 genre-image-placeholder"></div>
                        </div>
                        <div class="z-20 col-start-1 col-span-2 row-start-3 row-span-2 flex justify-center items-center">
                            <div class="w-full h-4/5 genre-image-placeholder"></div>
                        </div>
                        <div class="z-20 col-start-4 col-span-2 row-start-3 row-span-2 flex justify-center items-center">
                            <div class="w-full h-5/6 genre-image-placeholder"></div>
                        </div>
                        <div class="z-20 col-start-5 col-span-2 row-start-5 row-span-2 flex justify-center items-center">
                            <div class="w-5/6 h-4/5 genre-image-placeholder"></div>
                        </div>
                        <div class="z-20 col-start-11 col-span-2 row-start-5 row-span-2 flex justify-center items-center">
                            <div class="w-full h-5/6 genre-image-placeholder"></div>
                        </div>
                        <div class="z-20 col-start-6 col-span-2 row-start-7 row-span-2 flex justify-center items-center">
                            <div class="w-full h-4/5 genre-image-placeholder"></div>
                        </div>
                    </div>
                </section>

                <section class="py-16 py-24 relative bg-indigo-600">
                    <div class="px-6 mx-auto max-w-5xl flex items-center gap-12">
                        <div class="w-1/2">
                            <img src="assets/static/genero_para_ti.jpg" id="genero-imagen" alt="Imagen descriptiva del género" class="w-full max-w-md mx-auto rounded-2xl shadow-xl">
                        </div>
                        <div class="w-1/2">
                            <h2 id="genero-titulo" class="font-heading text-4xl md:text-5xl font-bold mb-4 text-cyan-50">GÉNERO PARA TI</h2>
                            <p id="genero-descripcion" class="text-cyan-50">Basado en tu historial este género musical es perfecto para ti y podria ser tu nueva obsesión.</p>
                            <p class="text-cyan-50">¡Descubrelo, es hora de expandir tus horizontes!</p>
                        </div>
                    </div>
                </section>
            </div>

            <div id="vista-resumen" data-content-route="resumen" class="hidden">
                <section class="py-16 md:py-24" style="background: linear-gradient(20deg, rgba(111, 115, 231, 0.91), rgba(76, 69, 206, 0.91));">
                    <div class="relative z-10 px-6 mx-auto max-w-5xl text-center"> 
                        <select id="time-range-select" class="mb-8 p-2 rounded-md text-blue-900 font-semibold">
                            <option value="long_term">Último año</option>
                            <option value="medium_term" selected>Últimos 6 meses</option>
                            <option value="short_term">Últimas 4 semanas</option>
                        </select>

                        <div id="contenedor-minutos-resumen" class="my-12">
                            <p class="text-gray-400">Cargando minutos...</p>
                        </div>
                        <h2 class="font-heading text-4xl md:text-5xl font-bold mb-12 text-white">Top 3 Artistas</h2>
                        <div class="contenedor-top-artistas grid grid-cols-1 md:grid-cols-3 gap-8 text-center min-h-[20rem] items-center justify-center"></div>
                        <h2 class="font-heading text-4xl md:text-5xl font-bold mt-12 mb-12 text-white">Top 3 Canciones</h2>
                        <div id="contenedor-top-canciones-resumen" class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center min-h-[20rem] items-start justify-center">
                            <p class="col-span-3 text-gray-400">Cargando tu top de canciones...</p>
                        </div>
                    </div>
                </section>
            </div>

            <div id="vista-escuchado-recientemente" data-content-route="reciente" class="hidden">
                <section class="py-16 md:py-48" style="background: linear-gradient(20deg, rgba(111,115,231,0.91), rgba(76,69,206,0.91));">
                    <div class="relative z-10 px-6 mx-auto max-w-5xl text-center"> 
                        <h2 class="font-heading text-4xl md:text-5xl font-bold mb-12 text-white">Canciones Escuchadas Recientemente</h2>
                        <div id="contenedor-canciones-recientes" class="grid grid-cols-1 sm:grid-cols-2 gap-x-12 gap-y-6 min-h-[10rem] items-start justify-center">
                            <p class="col-span-2 text-gray-400 text-center">Cargando tus canciones recientes...</p>
                        </div>
                    </div>
                </section>
            </div>

            <div id="vista-estadisticas-adicionales" data-content-route="estadisticas" class="hidden">
                <section class="py-16 md:py-48" style="background: linear-gradient(20deg, rgba(111,115,231,0.91), rgba(76,69,206,0.91));">
                    <div class="relative z-10 px-6 mx-auto max-w-5xl text-center"> 
                        <h2 class="font-heading text-4xl md:text-5xl font-bold mb-12 text-white">Más Estadísticas</h2>
                        
                        <div id="contenedor-perfil-usuario" class="grid grid-cols-1 sm:grid-cols-2 gap-x-12 gap-y-8 min-h-[10rem] items-center justify-items-center sm:justify-items-start max-w-lg mx-auto mb-16">
                            <p class="col-span-2 text-gray-400 text-center">Cargando tu perfil de usuario...</p>
                        </div>
                        
                        <select id="type-graph" class="mb-8 p-2 rounded-md text-blue-900 font-semibold">
                            <option value="doughnut" selected>Dona</option>
                            <option value="bar">Barra</option>
                            <option value="polarArea">Polar</option>
                            <option value="radar">Radar</option>
                        </select>

                        <h2 class="font-heading text-4xl md:text-5xl font-bold mt-16 mb-8 text-white">Géneros más escuchados segun tus artistas</h2>
                        <div class="bg-white/10 p-4 rounded-lg shadow-lg max-w-2xl mx-auto">
                            <canvas id="grafica-generos"></canvas>
                        </div>

                    </div>
                </section>
            </div>
            
            <div id="vista-eliminar-datos" data-content-route="eliminar" class="hidden">
                <section class="py-16 md:py-48" style="background: linear-gradient(20deg, rgba(111,115,231,0.91), rgba(76,69,206,0.91));">
                    <div class="relative z-10 px-6 mx-auto max-w-lg text-center">
                        <h2 class="font-heading text-4xl md:text-5xl font-bold mb-6 text-white">Eliminar Mis Datos</h2>
                        <p class="text-gray-300 mb-8">
                            Si continúas, se eliminarán todos los datos asociados a tu cuenta de Spotify de nuestra base de datos.
                            Esta acción es irreversible.
                        </p>
                        <button id="boton-eliminar-confirmar" class="bg-red-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-red-700 transition-all transform hover:scale-105 text-lg">
                            Confirmar Eliminación de Datos
                        </button>
                    </div>
                </section>
                </div>

            <div id="vista-terminos-de-uso" data-content-route="terminos" class="hidden">
                <section class="py-16 md:py-48" style="background: linear-gradient(20deg, rgba(111,115,231,0.91), rgba(76,69,206,0.91));">
                    <div class="col-span-2 text-gray-400 text-center">Esta zona aun esta en desarrollo</div>
                </section>
            </div>
        </main>
    </div>

<div id="offcanvas-backdrop" class="fixed inset-0 bg-black/50 z-40 hidden"></div>
    <div id="offcanvas-menu" class="fixed top-0 right-0 h-full w-80 bg-indigo-900 text-white shadow-lg transform translate-x-full transition-transform duration-300 ease-in-out z-50">
        <div class="flex justify-between items-center p-4 border-b border-white/20">
            <h5 class="text-lg font-bold">Menú</h5>
            <button id="close-menu-btn" class="p-2 rounded-md hover:bg-white/10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div class="p-4">
            <nav class="flex flex-col space-y-4 text-lg">
                <a href="#contenido-principal" class="hover:text-indigo-300 transition-colors">Home</a>
                <a href="#resumen-personal" class="nav-link hover:text-indigo-300 transition-colors" data-route="resumen">Resumen Personal</a>
                <a href="#escucha-reciente" class="nav-link hover:text-indigo-300 transition-colors" data-route="reciente">Escuchado Recientemente</a>
                <a href="#estaditicas-adicionales" class="nav-link hover:text-indigo-300 transition-colors" data-route="estadisticas">Más estadísticas</a>
                <a href="#eliminar-datos" class="nav-link hover:text-red-400 transition-colors" data-route="eliminar">Eliminar mis datos</a>
                <div class="border-b border-white/20 py-3"></div>
                <a href="#terminos-de-uso" class="nav-link hover:text-zinc-400 transition-colors" data-route="terminos">Términos de uso</a>

            </nav>
        </div>
    </div>

    <script>
        // Definicion de constantes
        const URL_BASE_API = 'http://127.0.0.1:5000'; //Cambiar al URL donde se aloje el backend (Cambiara cuando se suba a produccion)
        const contenedorLogin = document.getElementById('contenedor-login');
        const contenidoPrincipal = document.getElementById('contenido-principal');
        let generosChartInstance = null;

        // Funcion de manejo de autenticacion
        async function fetchConCredenciales(url) {
            const respuesta = await fetch(url, { credentials: 'include' });
            if (respuesta.status === 401) {
                mostrarLogin();
                throw new Error('Autorización necesaria');
            }
            if (!respuesta.ok) {
                throw new Error('La respuesta de la red no fue correcta');
            }
            return respuesta.json();
        }

        function mostrarLogin() {
            contenidoPrincipal.classList.add('hidden');
            contenedorLogin.classList.remove('hidden');
        }

        function mostrarPanel() {
            contenedorLogin.classList.add('hidden');
            contenidoPrincipal.classList.remove('hidden');
        }

        // Funciones asincronas para cargar datos desde el backend y actualizar el DOM
        async function cargarTopArtistas(time_range_elegido = 'long_term') {
            try {
                const url = `${URL_BASE_API}/api/top-artists?time_range=${time_range_elegido}`;
                const artistas = await fetchConCredenciales(url);
                const contenedores = document.querySelectorAll('.contenedor-top-artistas');
                contenedores.forEach(contenedor => {
                contenedor.innerHTML = '';
                const esVistaResumen = contenedor.closest('#vista-resumen');
                artistas.forEach(artista => {
                    // Ajusta clases segun la vista (reutilizacion de funciones)
                    let wrapperClasses = 'relative w-52 h-52';
                    let imageClasses = `w-full h-full object-cover ${artista.shape} shadow-lg`; 
                    let textClasses = 'text-blue-900';
                    if (esVistaResumen) {
                        wrapperClasses = 'relative w-[192px] h-[272px]';
                        imageClasses = 'w-full h-full object-cover rounded-full shadow-lg';
                        textClasses = 'text-white';
                    }
                    const tarjetaArtistaHTML = `
                        <div class="flex flex-col items-center">
                            <div class="${wrapperClasses}">
                                <img src="${artista.imageUrl}" alt="${artista.name}" class="${imageClasses}">
                            </div>
                            <h3 class="font-bold text-2xl mt-6 mb-2 ${textClasses}">${artista.name}</h3>
                            <p class="text-sm ${textClasses} max-w-xs">${artista.description}</p>
                        </div>
                    `;
                    contenedor.innerHTML += tarjetaArtistaHTML;
                });
                });
            } catch (error) {
                console.error('Error al cargar top de artistas:', error.message);
                if (error.message !== 'Autorización necesaria') {
                    const contenedores = document.querySelectorAll('.contenedor-top-artistas');
                    contenedores.forEach(contenedor => {
                        if (contenedor) {
                            contenedor.innerHTML = `<p class="text-red-400 col-span-3 text-center">Ocurrió un error al mostrar los datos.</p>`;
                        }
                    });
                }
            }
        }

        // Se comporta diferente segun el contenedor al que responda
        async function cargarTopCanciones(time_range_elegido = 'long_term') { 
            try {
                const url = `${URL_BASE_API}/api/top-tracks?time_range=${time_range_elegido}`;
                const canciones = await fetchConCredenciales(url);
                const contenedorPrincipal = document.getElementById('contenedor-top-canciones');
                if (contenedorPrincipal) {
                    contenedorPrincipal.innerHTML = '';
                    canciones.forEach(cancion => {
                        const cancionHTML = `
                            <div class="border-b border-white/20 py-3">
                                <p class="font-semibold">${cancion.name}</p>
                                <p class="text-sm text-gray-400">${cancion.artist}</p>
                            </div>
                        `;
                        contenedorPrincipal.innerHTML += cancionHTML;
                    });
                }
                const contenedorResumen = document.getElementById('contenedor-top-canciones-resumen');
                if (contenedorResumen) {
                    contenedorResumen.innerHTML = '';
                    const top3Canciones = canciones.slice(0, 3);
                    top3Canciones.forEach(cancion => {
                        const tarjetaCancionHTML = `
                            <div class="flex flex-col items-center text-left">
                                <div class="relative w-[272px] aspect-square">
                                    <img src="${cancion.imageUrl}" alt="${cancion.name}" class="w-full h-full object-cover rounded-lg shadow-lg">
                                </div>
                                <h3 class="font-semibold text-lg mt-4 text-white text-center">${cancion.name}</h3>
                                <p class="text-sm text-gray-300">${cancion.artist}</p>
                            </div>
                        `;
                        contenedorResumen.innerHTML += tarjetaCancionHTML;
                    });
                }
            } catch (error) {
                console.error('Error al cargar top de canciones:', error.message);
                if (error.message !== 'Autorización necesaria') {
                    const contenedor = document.getElementById('contenedor-top-canciones');
                    if (contenedor) {
                        contenedor.innerHTML = `<p class="text-red-400 col-span-2 text-center">Ocurrió un error al mostrar los datos.</p>`;
                    }
                }
            }
        }

        async function cargarCancionesRecientes(){
            try {
                const canciones = await fetchConCredenciales(`${URL_BASE_API}/api/recently-played`);
                const contenedor = document.getElementById('contenedor-canciones-recientes');
                contenedor.innerHTML = '';
                canciones.forEach(cancion => {
                    const cancionHTML = `
                        <div class="border-b border-white/20 py-3">
                            <p class="font-semibold">${cancion.name}</p>
                            <p class="text-sm text-gray-400">${cancion.artist}</p>
                        </div>
                    `;
                    contenedor.innerHTML += cancionHTML;
                });
            } catch (error) {
                console.error('No se encontraron las canciones:', error.message);
                if (error.message !== 'Autorización necesaria') {
                    const contenedor = document.getElementById('contenedor-top-canciones');
                    contenedor.innerHTML = `<p class="text-red-400 col-span-2 text-center">No se pudo cargar la información.</p>`;
                }
            }
        }

        async function cargarPerfilUsuario(){
            try{
                const perfil =  await fetchConCredenciales(`${URL_BASE_API}/api/user-profile`);
                const contenedor = document.getElementById('contenedor-perfil-usuario');
                if (!contenedor) return; 
                const perfilHTML = `
                    <div class="flex items-center space-x-4 justify-center sm:justify-start">
                        <img src="${perfil.imageUrl}" alt="${perfil.name}" class="w-16 h-16 rounded-full object-cover shadow-lg">
                        <div class="flex flex-col text-left">
                            <h3 class="font-bold text-xl text-white">${perfil.name}</h3>
                            <h4 class="text-sm text-gray-300">${perfil.product}</h4>
                        </div>
                    </div>
                `;
                contenedor.innerHTML += perfilHTML;

            }catch(error){
                console.error('No se encontro el perfil: ', error.message);
                if(error.message !== 'Autorización necesaria'){
                    const contenedor = document.getElementById('contenedor-perfil-usuario');
                    if (contenedor) {
                        contenedor.innerHTML += `<p class="text-red-400">No se pudo cargar el perfil.</p>`;
                    }
                }
            }
        }

        // Funcion para cargar minutos escuchados
        async function cargarMinutos() {
            try {
                const minutos = await fetchConCredenciales(`${URL_BASE_API}/api/listening-minutes`);
                const minutosFormateados = Math.round(minutos.totalMinutes).toLocaleString();
                const contenedorPerfil = document.getElementById('contenedor-perfil-usuario');
                if (contenedorPerfil) {
                    const minutosPerfilHTML = `
                        <div class="flex flex-col items-center justify-center text-center">
                            <p class="text-3xl font-bold text-white">${minutosFormateados}</p>
                            <p class="text-sm text-gray-300">Minutos escuchados (Total)</p>
                        </div>
                    `;
                    contenedorPerfil.innerHTML += minutosPerfilHTML; 
                }
                const contenedorResumen = document.getElementById('contenedor-minutos-resumen');
                if (contenedorResumen) {
                    const minutosResumenHTML = `
                        <p class="text-5xl font-bold text-white">${minutosFormateados}</p>
                        <p class="text-lg text-gray-300 mt-2">Minutos Totales de Escucha</p>
                    `;
                    contenedorResumen.innerHTML = minutosResumenHTML;
                }

            }catch(error){
                console.error('No se encontraron los minutos escuchados: ', error.message);
                if (error.message !== 'Autorización necesaria') {
                    // Manejar error en ambos contenedores
                    const contenedorPerfil = document.getElementById('contenedor-perfil-usuario');
                    if (contenedorPerfil) {
                         contenedorPerfil.innerHTML += `<p class="text-red-400">Error al cargar minutos.</p>`;
                    }
                    const contenedorResumen = document.getElementById('contenedor-minutos-resumen');
                    if (contenedorResumen) {
                        contenedorResumen.innerHTML = `<p class="text-red-400 col-span-2 text-center">No se pudo cargar la información de minutos escuchados.</p>`;
                    }
                }
            }
        }


        async function cargarGeneros() {
            try {
                const generos = await fetchConCredenciales(`${URL_BASE_API}/api/top-genres`);
                // const contenedor = document.getElementById('contenedor-generos');
                // if (contenedor) {
                //     contenedor.innerHTML = '';
                // }

                generosDataCache = generos;

                if (generos.length === 0) {
                    // if (contenedor) {
                    //     contenedor.innerHTML = '<p class="text-gray-400 col-span-2 text-center">No se encontraron géneros principales.</p>';
                    // }
                    if (generosChartInstance) {
                        generosChartInstance.destroy();
                        generosChartInstance = null;
                    }
                    return;
                }
                // generos.forEach(genero => {
                //     const generoHTML = `
                //         <div class="border-b border-white/20 py-3 w-full text-left">
                //             <p class="font-semibold text-white capitalize">${genero.genre}</p>
                //             <p class="text-sm text-gray-400">Apariciones: ${genero.count}</p>
                //         </div>
                //     `;
                //     if (contenedor) {
                //         contenedor.innerHTML += generoHTML;
                //     }
                // });
                const selectorTipo = document.getElementById('type-graph');
                const tipoSeleccionado = selectorTipo ? selectorTipo.value : 'doughnut';

                crearGraficaGeneros(generos, tipoSeleccionado);

            } catch (error) {
                console.error('No se encontraron los géneros: ', error.message);
                if (error.message !== 'Autorización necesaria') {
                    // const contenedor = document.getElementById('contenedor-generos'); 
                    // if (contenedor) {
                    //     contenedor.innerHTML = `<p class="text-red-400 col-span-2 text-center">No se pudo cargar la información de géneros.</p>`;
                    // }
                    console.error("No se pudo cargar la información de géneros.");
                }
            }
        }

        // Coloca esto después de tu función cargarGeneros()
        async function cargarRecomendacionGenero() {
            try {
                const data = await fetchConCredenciales(`${URL_BASE_API}/api/genre-recommendation`);
                
                // Actualizamos los elementos del DOM con los IDs que pusimos
                const imgEl = document.getElementById('genero-imagen');
                const tituloEl = document.getElementById('genero-titulo');
                const descEl = document.getElementById('genero-descripcion');

                if (imgEl) imgEl.src = data.imageUrl;
                if (tituloEl) tituloEl.innerText = data.genre.toUpperCase();
                if (descEl) descEl.innerText = `Ya que te gusta ${data.basedOn}, ¡te recomendamos explorar el género ${data.genre}! Artistas como ${data.artist} son un buen punto de partida.`;

            } catch (error) {
                console.error('Error al cargar la recomendación de género:', error.message);
                // No mostramos un error, simplemente dejamos la sección como está.
            }
        }

        // Funcion para eliminar datos del usuario segun requerido en el acuerdo legal de Spotify (Función desactivada temporalmente para pruebas)
        async function eliminarDatosUsuario() {
            if (!confirm("¿Estás seguro de que quieres eliminar todos tus datos? Esta acción no se puede deshacer.")) {
                return;
            }
            console.log("PRUEBA: La llamada a la API de eliminación ha sido omitida.");
            alert("PRUEBA: Simulación de 'Datos eliminados'. No se borró nada. Redirigiendo a la página de inicio.");
            mostrarLogin();


            /*
            // ===== CÓDIGO ORIGINAL DESACTIVADO TEMPORALMENTE =====
            try {
                // 2. Llamar al endpoint (asumiendo que es un POST a /api/delete-my-data)
                const respuesta = await fetch(`${URL_BASE_API}/api/delete-my-data`, { 
                    method: 'POST',
                    credentials: 'include' 
                });

                if (respuesta.status === 401) {
                    mostrarLogin();
                    throw new Error('Autorización necesaria');
                }

                if (!respuesta.ok) {
                    throw new Error('Error al contactar al servidor');
                }

                const resultado = await respuesta.json();
                
                // 3. Informar y redirigir
                alert(resultado.message || "Datos eliminados correctamente. Serás redirigido a la página de inicio.");
                
                // 4. Mostrar el login
                mostrarLogin(); 

            } catch (error) {
                console.error('Error al eliminar datos:', error.message);
                alert("No se pudieron eliminar los datos. Por favor, inténtalo de nuevo más tarde.");
            }
            */
        }

        // Funcion para crear las graficas
        function crearGraficaGeneros(generosData, graphType) {
            const ctx = document.getElementById('grafica-generos');
            if (!ctx) return; 
            if (generosChartInstance) {
                generosChartInstance.destroy();
            }
            const labels = generosData.map(g => g.genre);
            const dataPoints = generosData.map(g => g.count);
            const backgroundColors = [
                'rgba(255, 99, 132, 0.7)',
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(153, 102, 255, 0.7)',
                'rgba(255, 159, 64, 0.7)',
                'rgba(199, 199, 199, 0.7)',
                'rgba(83, 109, 254, 0.7)',
                'rgba(40, 222, 190, 0.7)',
                'rgba(250, 100, 100, 0.7)'
            ];
            const borderColors = backgroundColors.map(color => color.replace('0.7', '1'));
            // Definicion de opciones generales de las graficas
            let chartOptions = {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#FFFFFF', 
                            font: {
                                size: 14
                            }
                        }
                    },
                    title: {
                        display: false 
                    }
                }
            };
            // If anidados para modificar las graficas dependiendo su tipo
            if (graphType === 'bar') {
                chartOptions.scales = {
                    x: {
                        ticks: {
                            color: '#FFFFFF'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#FFFFFF',
                            stepSize: 1 
                        }
                    }
                };
            } else if (graphType === 'polarArea') {
                chartOptions.scales = {
                    r: { 
                        beginAtZero: true,
                        ticks: { 
                            color: '#FFFFFF', 
                            stepSize: 1,      
                            backdropColor: 'transparent'
                        }
                    }
                };
            } else if (graphType === 'radar') {
                chartOptions.scales = {
                    r: {
                        beginAtZero: true,
                        ticks: { 
                            color: '#FFFFFF',
                            stepSize: 1,
                            backdropColor: 'transparent'
                        },
                        pointLabels: { 
                            color: '#FFFFFF', 
                            font: {
                                size: 12 
                            }
                        }
                    }
                };
            }
            // Creacion de las graficas
            generosChartInstance = new Chart(ctx, {
                type: graphType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Apariciones de Géneros',
                        data: dataPoints,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: chartOptions 
            });
        }

        // Manejo de rutas y eventos
        document.addEventListener('DOMContentLoaded', () => {
            // --- Lógica del Off-canvas ---
            const openMenuBtn = document.getElementById('open-menu-btn');
            const closeMenuBtn = document.getElementById('close-menu-btn');
            const offcanvasMenu = document.getElementById('offcanvas-menu');
            const offcanvasBackdrop = document.getElementById('offcanvas-backdrop');
            const offcanvasLinks = offcanvasMenu.querySelectorAll('a');

            function openMenu() {
                offcanvasMenu.classList.remove('translate-x-full');
                offcanvasBackdrop.classList.remove('hidden');
            }

            function closeMenu() {
                offcanvasMenu.classList.add('translate-x-full');
                offcanvasBackdrop.classList.add('hidden');
            }

            openMenuBtn.addEventListener('click', openMenu);
            closeMenuBtn.addEventListener('click', closeMenu);
            offcanvasBackdrop.addEventListener('click', closeMenu);
            
            offcanvasLinks.forEach(link => {
                link.addEventListener('click', closeMenu);
            });

            // Listener para el botón de eliminar
            const botonEliminar = document.getElementById('boton-eliminar-confirmar');
            if (botonEliminar) {
                botonEliminar.addEventListener('click', eliminarDatosUsuario);
            }
            const navLinks = document.querySelectorAll('.nav-link');
            const scrollLinks = document.querySelectorAll('.scroll-link');
            const contentSections = document.querySelectorAll('[data-content-route]');
            const defaultRoute = 'inicio';
            const timeRangeSelector = document.getElementById('time-range-select');
            if(timeRangeSelector){
                timeRangeSelector.addEventListener('change', (event) => {
                    const nuevoTimeRange = event.target.value;
                    cargarTopArtistas(nuevoTimeRange);
                    cargarTopCanciones(nuevoTimeRange);
                });
            }
            const typeGraphSelector = document.getElementById('type-graph')
            if (typeGraphSelector){
                typeGraphSelector.addEventListener('change', (event) => {
                const nuevoTipo = event.target.value;
                if (generosDataCache.length > 0){
                crearGraficaGeneros(generosDataCache, nuevoTipo);
                }
                });
            }

        function handleRouteChange(route) {
            contentSections.forEach(section => {
                section.classList.add('hidden');
            });
            const activeSection = document.querySelector(`[data-content-route="${route}"]`);
            if (activeSection) {
                activeSection.classList.remove('hidden');
                if(route === 'reciente'){
                    cargarCancionesRecientes();
                } else if (route === 'estadisticas'){
                    const contenedorPerfil = document.getElementById('contenedor-perfil-usuario');
                    if (contenedorPerfil) {
                        contenedorPerfil.innerHTML = ''; 
                    }
                    cargarPerfilUsuario();
                    cargarMinutos(); 
                    cargarGeneros(); 
                } else if (route === 'resumen') {
                    const selector = document.getElementById('time-range-select');
                    const timeRange = selector ? selector.value : 'medium_term';
                    
                    cargarTopArtistas(timeRange);
                    cargarTopCanciones(timeRange);
                    cargarMinutos(); 
                }

            } else {
                document.querySelector(`[data-content-route="${defaultRoute}"]`).classList.remove('hidden');
                }
            }

        navLinks.forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault();
                const route = link.getAttribute('data-route');
                history.pushState({ route }, '', link.getAttribute('href'));
                handleRouteChange(route);
                });
        });

        // Manejo de enlaces para desplazarse
        scrollLinks.forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault();
                const mainView = document.getElementById('vista-inicio');
                const targetId = link.getAttribute('href');
                if (mainView.classList.contains('hidden')) {
                    handleRouteChange('inicio');
                    history.pushState({ route: 'inicio' }, '', '/');
                }
                setTimeout(() => {
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } 
                }, 100);
            });
        });

        // Manejo de eventos por medio de un operador ternario y llamado a la funcion de manejo de rutas
        window.addEventListener('popstate', (event) => {
            const route = (event.state && event.state.route) ? event.state.route : defaultRoute;
            handleRouteChange(route);
        });

        // Funcion asincrona de inicializacion
        async function initialize() {
            try {
                const timeRangeSelector = document.getElementById('time-range-select');
                const initialRange = (timeRangeSelector && timeRangeSelector.value) ? timeRangeSelector.value : 'long_term';

                await Promise.all([
                    cargarTopArtistas(initialRange), 
                    cargarTopCanciones(initialRange),
                    cargarCancionesRecientes(),
                    cargarRecomendacionGenero() // <-- ¡LÍNEA AÑADIDA!
                ]);

                mostrarPanel();
                const initialPath = window.location.pathname;
                let initialRoute = 'inicio';
                
                handleRouteChange(initialRoute);
            } catch (error) {
                if (error.message === 'Autorización necesaria') {
                    console.log("Authorization required, showing the login page.");
                    mostrarLogin();
                } else {
                    console.error("An error occurred during initialization:", error);
                }
            }
        }
            initialize();
        });
    </script>
</body>
</html>